---
title: "Proyecto 4 - Intoxicaciones por pesticidas en Costa Rica durante el periodo 2007 al 2014"
author: "Andrés Arguedas Leiva - Natalia Díaz Ramírez"
date: "29 de noviembre del 2018"
output: pdf_document
header-includes: 
  \renewcommand{\caption}{Nota:}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, dev = 'pdf')
library(dplyr)
library(tidyr)
library(forcats)
library(ggplot2)
library(lubridate)
library(ggrepel)
library(foreign)
library(spatstat)
library(raster)
library(rgdal)
library(spdep)
library(RColorBrewer)
```

# Introducción

Las intoxicaciones por pesticidas son un problema de salud pública a nivel mundial debido a la alta morbilidad y mortalidad que pueden causar. Dentro de la categoría de intoxicaciones por pesticidas se destacan causas como el intento suicida, el cual representa uno de los casos más graves de intoxicación; la causa ocupacional, principalmente en los trabajadores dedicados a labores agrícolas; y la causa accidental, la cual es muy frecuente en niños. Los efectos que pueden producir los plaguicidas en las poblaciones expuestas dependen de la toxicidad, la dosis, la forma de ingreso al organismo y el tiempo de exposición. (Martínez & Gómez, 2007, pp.190). 

Las preguntas de investigación planteadas son "¿Existen conglomerados que se puedan localizar geográficamente por cantones para los casos de intoxicaciones por pesticidas? En caso de que existan, ¿serán distintas si se toma en cuenta la población del cantón?" Por lo tanto, el objetivo de este artículo es determinar si existen aglomeraciones de cantones con respecto a la cantidad de intoxicaciones por pesticida, tanto de forma absoluta, como con respecto a la población del cantón.
  
# Metodología
  
Los datos utilizados en este artículo se obtuvieron de los registros de consultas telefónicas del Centro Nacional de Control de Intoxicaciones. El proceso de registro de los casos de intoxicaciones se da por medio de llamadas telefónicas, estas pueden ser realizadas por profesionales en el área de salud como médicos y paramédicos o también por personas particulares. Un farmacéutico especializado en toxicología es el encargado de registrar la información referente al caso de la persona intoxicada en una hoja de registro de consulta toxicológicas, la cual es procesada, posteriormente, de forma digital. Por lo tanto, se cuenta con 11038 casos de intoxicaciones durante los años 2007 al 2014, que incluye variables como la fecha, el sexo de la persona, su edad, la razón de ingesta, el cantón de residencia, entre otros.

Estos datos se analizaron mediante métodos y modelos de estadistica de áreas, usando la prueba de la I de Moran, tests locales y distintos métodos para determinar los vecinos y los pesos entre estos. Los datos fueron procesados mediante el software R, en la interfaz gráfica RStudio y se usaron los paquetes \textit{dplyr}, \textit{tidyr}, \textit{forcats}, \textit{ggplot2}, \textit{lubridate}, \textit{ggrepel}, \textit{foreign}, \textit{spatstat}, \textit{raster}, \textit{rgdal}, \textit{spdep} y \textit{RColorBrewer}.

# Resultados

```{r,include=FALSE}

#####################
#Limpieza de datos
#####################

base <- read.spss("datos/base-descriptivo.sav")
base <- as.data.frame(base)

#mezclo: si mezclo mas de una sustancia o no 
#causarec: hace regerencia a la causa de la intoxicacion como tentativa suicida, accidental,ocupacional, mal uso(por ejemplo cuando no usan la debida proteccion en ropa o lentes)
#rutarec: el medio por el que se dio la intoxicacion, ingestion, inhalacion, etc

#dejar solo variables de interes
base <- base[,c(1:4, 6, 7, 14, 19, 20)]
colnames(base) <- c("ID", "anio", "provinciarec", "cantonrec", "grupo_edad", "sexo", "mezclo", "causarec", "rutarec")

#Pasa a otra variable el canton ya que esta codificada como factores
base_temp <- base %>% mutate(Canton = as.character(cantonrec))
base_temp <- base_temp %>% dplyr::select(-cantonrec)
#Modifica el nombre de algunos cantones para poder unirlo con las otras bases del paquete ggcr(este da el mapa de Costa Rica para poder graficarlo)
base_temp <- base_temp %>% mutate(Canton = ifelse(Canton == "León Cortés Castro", "Leon Cortes",
                                                  ifelse(Canton == "Vázquez de Coronado", "Vazquez De Coronado",
                                                         ifelse(Canton == "Montes de Oro", "Montes De Oro",
                                                                ifelse(Canton == "Montes de Oca","Montes De Oca",
                                                                       Canton)))))


#quitar tildes en variable provincia
base_temp <- base_temp %>% mutate(Provincia = chartr('áéíóúñ', 'aeioun', provinciarec))
base_temp <- base_temp %>% dplyr::select(-provinciarec)
#quitar tildes en variable canton
base_temp <- base_temp %>% mutate(Canton = chartr('áéíóúñ', 'aeioun', Canton))
base_temp <- base_temp %>% filter(!(Canton == "99" | Canton == "Extranjero"))

#agregar la poblacion segun el censo 2011 por canton
#leer datos del censo
censo <- read.csv("datos/censo_inec_2011.csv", stringsAsFactors = F, encoding = "UTF-8")

#selecciona las variables provincia, canton, distritos y poblacion
censo <- censo %>% dplyr::select(Provincia, Canton, Distrito, Poblacion_Total)
#quitar tildes en variable provincia
censo <- censo %>% mutate(Provincia = chartr('áéíóúñ', 'aeioun', Provincia))
#quitar tildes en variable canton
censo <- censo %>% mutate(Canton = chartr('áéíóúñ', 'aeioun', Canton))

#Cambia algunos nombres para luego unir con otras bases del paquete ggcr
censo2 <- censo %>% mutate(Canton = ifelse(Canton == "Ca~nas", "Canas",
                                           ifelse(Canton == "Leon Cort'es Castro","Leon Cortes",
                                                  ifelse(Canton == "Perez Zeled'on", "Perez Zeledon",
                                                         ifelse(Canton == "Vazquez de Coronado", "Vazquez De Coronado",
                                                                ifelse(Canton == "Montes de Oro", "Montes De Oro",
                                                                       ifelse(Canton == "Montes de Oca", "Montes De Oca",
                                                                              Canton)))))))

#poblacion por canton
censo2 <- censo2 %>% 
  group_by(Provincia, Canton) %>%
  mutate(poblacion = sum(Poblacion_Total))
#selecciona variables de interes y elimina duplicados
censo2 <- censo2 %>% 
  dplyr::select(Provincia, Canton, poblacion) %>% 
  distinct(Provincia, Canton, .keep_all=T)
#ordena por provincia y canton
censo2 <- censo2 %>% arrange(Provincia, Canton)

#unir casos con censo
base2 <- merge(base_temp, censo2, by = c("Provincia", "Canton"), all.x = F)
base2 <- base2 %>% mutate(Canton = ifelse(Canton == "Canas", "Cañas", Canton))

#cantidad de intoxicaciones por canton
base_temp <- base2 %>% 
  group_by(Canton) %>%
  mutate(intoxicaciones = n())

#selecciona variables de interes y elimina duplicados
base_temp <- base_temp %>% 
  dplyr::select(Provincia, Canton, intoxicaciones, poblacion) %>% 
  distinct(Canton, .keep_all = T)

#calcula la cantidad por cada diezmil habitantes
base_temp <- base_temp %>% mutate(llamadas_10mil = round((intoxicaciones / poblacion) * 10000, 4))



# Cambiar shapefile para eliminar Isla del Coco
s <- shapefile("CRI_adm/CRI_adm2.shp")
sub <- crop(s, extent(-88, -82, 7, 12))
#plot(sub, axes = T, border = 'gray')
shapefile(sub, 'datos/cantones.shp',overwrite=TRUE)

### Load a shape file and merge it with a csv
### Author: Jose Gonzalez 
### www.jose-gonzalez.org

# This script shows how to load a shapefile, merge it with a csv and save it with the proper encoding
### Load rgdal
#require(rgdal)
# Load shapefile using "UTF-8". Notice the "." is the directory and the shapefile name 
# has no extention
shp  <- readOGR("datos", "cantones", stringsAsFactors=FALSE, encoding="UTF-8")
# Explore with a quick plot
#plot(shp, axes=TRUE, border="gray")

# Cambio de nombres de los cantones
shp$NAME_2[shp$NAME_2 %in% setdiff(unique(shp$NAME_2), unique(base_temp$Canton))] <- c("Zarcero", "Poas", "San Ramon", "Jimenez", "La Union", "Paraiso","Cañas", "Tilaran", "Belen", "Santa Barbara", "Sarapiqui", "Guacimo", "Limon", "Pococi", "Montes De Oro", "Aserri", "Escazu", "Leon Cortes","Montes De Oca", "Perez Zeledon", "San Jose", "Tarrazu", "Tibas","Vazquez De Coronado")

# Verifiquemos que se cambi?
#setdiff(unique(shp$NAME_2), unique(base_temp$Canton))

# Merge shapefile and csv
temp  <- merge(shp, base_temp, by.x="NAME_2", by.y="Canton") 

# The shapefile behaves as a data.frame. Explore a bit
head(temp)
```

En esta sección se presentan algunas estadísticas descriptivas acerca del conjunto de datos, seguido por una comparación entre distintos métodos para determinar vecinos y los pesos entre estos, luego, con base en estos pesos entre vecinos, se calcula la prueba I de Moran bajo distintos supuestos para determinar la existencia de autocorrelación espacial y, por último, se determinan puntos calientes y aglomerados en los cantones. Para empezar, los gráficos 1 y 2 presentan la cantidad y la tasa por cada 10 mil habitantes de intoxicaciones por pesticidas, respectivamente, para cada cantón de Costa Rica.

```{r, out.width= '5in', fig.align = 'center'}
# Cantidad de intoxicaciones, totales, por cantón
spplot(temp, "intoxicaciones", col.regions=brewer.pal(9, "YlOrRd"), at = seq(0, 740, length.out = 9), main = "Gráfico 1:\nCantidad de intoxicaciones por pesticidas según \ncantón, en Costa Rica, del 2007 al 2014", par.settings = list(axis.line = list(col = "transparent")), colorkey = list(axis.line = list(col = "black")))

# Cantidad de intoxicaciones, por 10 mil habitantes, por cantón
spplot(temp, "llamadas_10mil", col.regions=brewer.pal(9, "YlOrRd"), at = seq(0, 80, length.out = 9), main = "Gráfico 2:\nCantidad de intoxicaciones por pesticidas por 10 mil habitantes,\n según cantón, en Costa Rica, del 2007 al 2014", par.settings = list(axis.line = list(col = "transparent")), colorkey = list(axis.line = list(col = "black")))
```

Con base en el Gráfico 1, se puede notar que en el cantón de San Carlos hay una cantidad bastante grande de intoxicaciones por pesticidas, comparativamente con los demás cantones. Por otro lado, además de la gran cantidad de intoxicaciones en ese cantón, no parecen haber, de forma visual, aglmoeraciones de cantones con muchos casos reportados de intoxicaciones. Al contrario, con base en el Gráfico 2, se puede notar que si parecen haber aglomeraciones de cantones con tasas de intoxicaciones altas, como son el caso de los cantones de Coto Brus, Buenos Aires, Talamanca y Limón en el este del país y de los cantones de Upala, Los Chiles y Guatuso en el norte del país. También cabe mencionar que, en términos relativos, el cantón de San Carlos no tiene un valor tan distinto a los demás cantones, como si ocurre cuando se toman la cantidad de casos absolutos. 

Teniendo una noción sobre la distribución de los datos en los cantones del país, es necesario determinar vecinos entre los cantones para poder hacer los análisis de estadística de áreas. Por lo anterior, en el Gráfico 3 se presenta una visualización de seis formas distintas de determinar cantones vecinos en el país.

```{r, fig.cap = " a) Método de la reina b) Método de la torre c) k vecinos más cercanos usando k=1 d) k vecinos más cercanos usando k=2 e) k vecinos más cercanos usando k=4 f) k vecinos más cercanos con distancia máxima igual a la distancia máxima obtenido mediante la reina", out.width= '5in', fig.align = 'center'}
# Definición de coordenadas y ID's para hacer mapas
coords <- coordinates(temp)
IDs <- row.names(temp)

par(xaxt = "n", yaxt = "n", tck = 0, mfrow = c(2, 3), mai = c(0, 0, 0, 0), oma = c(0, 0, 2, 0), bty = "n")
# Reina
temp1_nb <- poly2nb(temp)
plot(shp, axes=TRUE, border="gray")
plot(temp1_nb, coordinates(temp), pch = 19, cex = 0.6, add = T, col = "red")
text(bbox(temp)[1,1], bbox(temp)[2,2], labels="a)", cex=0.8)
box(col = "white")
# Torre
temp2_nb <- poly2nb(temp, queen = F)
plot(shp, axes=TRUE, border="gray")
plot(temp2_nb, coordinates(temp), pch = 19, cex = 0.6, add = T, col = "red")
text(bbox(temp)[1,1], bbox(temp)[2,2], labels="b)", cex=0.8)
box(col = "white")
# kNN 1 vecino
temp8_nb <- knn2nb(knearneigh(coords, k=1), row.names=IDs)
plot(shp, axes=TRUE, border="gray")
plot(temp8_nb, coordinates(temp), pch=19, cex=0.6, add = T, col = "red")
text(bbox(temp)[1,1], bbox(temp)[2,2], labels="c)", cex=0.8)
box(col = "white")
# kNN 2 vecinos
temp9_nb <- knn2nb(knearneigh(coords, k=2), row.names=IDs)
plot(shp, axes=TRUE, border="gray")
plot(temp9_nb, coordinates(temp), pch=19, cex=0.6, add = T, col = "red")
text(bbox(temp)[1,1], bbox(temp)[2,2], labels="d)", cex=0.8)
box(col = "white")
# kNN con 4 vecinos
temp10_nb <- knn2nb(knearneigh(coords, k=4), row.names=IDs)
plot(shp, axes=TRUE, border="gray")
plot(temp10_nb, coordinates(temp), pch=19, cex=0.6, add = T, col = "red")
text(bbox(temp)[1,1], bbox(temp)[2,2], labels="e)", cex=0.8)
box(col = "white")
# kNN con distancia según reinas
dsts <- unlist(nbdists(temp1_nb, coords))
temp12_nb <- dnearneigh(coords, d1=0, d2=0.75*max(dsts), row.names=IDs)
plot(shp, axes=TRUE, border="gray")
plot(temp12_nb, coordinates(temp), pch=19, cex=0.6, add = T, col = "red")
text(bbox(temp)[1,1], bbox(temp)[2,2], labels="f)", cex=0.8)
box(col = "white")

title("Gráfico 3:\nComparación de seis métodos distintos para determinar cantones vecinos en Costa Rica", outer = TRUE)
```

Se puede notar del Gráfico 3 que las formas de determinar los cantones vecinos son bastante distintos entre sí. Aun así, hay algunos de estos métodos que no dan resultados lógicos acorde con la estructura del país, por ejemplo, cuando se usa k vecinos más cercanos con 1 o 2 vecinos (los gráficos c) y d), respectivamente), hay una gran cantidad de conexiones en el Valle Central del país, mientras que los cantones en la periferia se conectan con los cantones centrales solamente mediante 2 conexiones. Esto no tiene sentido ya que no hay una conexión entre los cantones de Turrialba y Limón, por ejemplo, aunque las condiciones presentes en estos dos cantones sean parecidos y admás se pueden conectar por distintas formas. Caso contrario a lo que pasa cuando se pone una distancia máxima muy grande, como sucede en el gráfico f), donde hay más conexiones de la cuenta y hay conexiones directas entre cantones que están muy alejados y cuyas condiciones son notablemente distintas. 

Por lo anterior, se decidió usar el método de la reina para determinar vecinos, aunque también cabe resaltar que los métodos de la torre y de k vecinos más cercanos con 4 vecinos también son opciones que tienen sentido en el contexto. Al haber determinado la forma en la cual se determinan los cantones vecinos, es necesario calcular los pesos entre estos vecinos por lo que, en el Gráfico 4, se presenta la comparación de la distribución de pesos entre vecinos usando tres métodos distintos:

```{r,include=FALSE}
# Reina
temp1_nb_W=nb2listw(temp1_nb)
temp1_nb_W

# Reina
temp1_nb_W=nb2listw(temp1_nb,style = "W")
summary(unlist(temp1_nb_W$weights))
summary(sapply(temp1_nb_W$weights, sum))

temp1_nb_B=nb2listw(temp1_nb,style = "B")
summary(unlist(temp1_nb_B$weights))
summary(sapply(temp1_nb_B$weights, sum))

temp1_nb_S=nb2listw(temp1_nb,style = "S")
summary(unlist(temp1_nb_S$weights))
summary(sapply(temp1_nb_S$weights, sum))
```

```{r, out.width= '5in', fig.align = 'center', fig.cap = " El estilo W estandariza por fila, el estilo B pone peso 1 a vecinos y 0 a no vecinos y el estilo S usa estabilización de variancia."}
#Reina
pal <- brewer.pal(9, "Reds")
oopar <- par(mfrow=c(1,3), mar=c(1,1,3,1)+0.1, oma = c(0, 0, 2, 0))
z <- t(listw2mat(temp1_nb_W))
brks <- c(0,0.1,0.143,0.167,0.2,0.5,1)
nbr3 <- length(brks)-3
image(1:81, 1:81, z[,ncol(z):1], breaks=brks, col=pal[c(1,(9-nbr3):9)],
      main="Estilo W", axes=FALSE)
box()
z <- t(listw2mat(temp1_nb_B))
image(1:81, 1:81, z[,ncol(z):1], col=pal[c(1,9)], main="Estilo B", axes=FALSE)
box()
z <- t(listw2mat(temp1_nb_S))
image(1:81, 1:81, z[,ncol(z):1], col=pal[c(1,(9-nbr3):9)], main="Estilo S", axes=FALSE)
box()

title("Gráfico 4:\nComparación de distancias entre vecinos según distintos criterios de peso ", outer = TRUE)

par(oopar)
```

Al comparar los tres estilos de determinar pesos mostrados en el Gráfico 4, parece que el estilo W tiene una menor cantidad de pesos comparado con los otros dos estilos, mientras que la diferencia entre el estilo B y el S radica en que el B solo tiene dos valores posibles (1 y 0), mientras que el S toma valores en un continuo. En este caso, ya que no se tiene una razón teórica para escoger uno de los estilos, se decidió usar el estilo S, ya que minimiza el impacto final sobre los resultados.

Habiendo definido los vecinos y los pesos entre estos, se procede a realizar la prueba de la I de Moran parar determinar la existencia de autocorrelación espacial entre los datos. Las pruebas realizadas con respecto al total de intoxicaciones por cantón fueron la I de Morán de los residuales (p-value=0.71) y las aproximaciones mediante punto de silla (p-value=0.70) y la exacta (p-value=0.70), además del test de permutaciones (p-value=0.69). Con base en estos resultados, no parece haber autocorrelaciones espaciales entre los cantones con respecto a la cantidad total de intoxicaciones. Aun así, es importante recordar que estos valores son conteos y la población por cantón es muy distinta, por lo que es más apropiado tomar en cuenta la población de cada cantón para poder determinar la existencia de autocorrelaciones espaciales. Por lo anterior, al realizar la EBI de Moran se obtiene un p-value de 0.001, lo que indica que, cuando se toma en cuenta la población de los cantones, si existe una autocorrelación espacial.

Con base en los resultados anteriores, se realizaron las mismas pruebas de la I de Moran pero para la tasa de intoxicaciones por 10 mil habitantes y, para las tres variaciones de la prueba, todos los p-values tuvieron 6 cifras significativas, por lo que si parece haber autocorrelaciones espaciales entre los cantones al usar la tasa por 10 mil habitantes. Por lo tanto, existen autocorrelaciones espaciales entre los cantones cuando se usa la tasa por 10 mil habitantes, pero no cuando se toma la cantidad de intoxicaciones totales. Por lo anterior, en los gráficos 5, 6, 7 y 8 se presenta los cantones de influencia y los posibles puntos calientes y aglomeraciones usando la cantidad de intoxicaciones totales o por 10 mil habitantes, respectivamente.

```{r, include = FALSE}
#reina

set.seed(987)
n <- length(temp1_nb)
uncorr_x <- rnorm(n)
rho <- 0.5
autocorr_x <- invIrW(temp1_nb_S, rho) %*% uncorr_x

lm.morantest(lm(temp$intoxicaciones ~ 1, temp), listw=temp1_nb_S)
lm.morantest.sad(lm(temp$intoxicaciones ~ 1, temp), listw=temp1_nb_S)
lm.morantest.exact(lm(temp$intoxicaciones ~ 1, temp), listw=temp1_nb_S)

set.seed(1234)
bperm <- moran.mc(temp$intoxicaciones, listw=temp1_nb_S, nsim=999)
bperm

set.seed(1234)
EBImoran.mc(n=temp$intoxicaciones, x=temp$poblacion, listw=nb2listw(temp1_nb, style="S"), nsim=999)

# Llamadas por 10 mil habitantes

lm.morantest(lm(temp$llamadas_10mil ~ 1, temp), listw=temp1_nb_S)
lm.morantest.sad(lm(temp$llamadas_10mil ~ 1, temp), listw=temp1_nb_S)
lm.morantest.exact(lm(temp$llamadas_10mil ~ 1, temp), listw=temp1_nb_S)
```

```{r, out.width= '5in', fig.align = 'center'}
oopar <- par(mfrow=c(1,2), oma = c(0, 0, 2, 0))
msp <- moran.plot(temp$intoxicaciones, listw=nb2listw(temp1_nb, style="C"), quiet=TRUE, xlab = "Intoxicaciones", ylab = "Intoxicaciones rezagadas espacialmente")
infl <- apply(msp$is.inf, 1, any)
x <- temp$intoxicaciones
lhx <- cut(x, breaks=c(min(x), mean(x), max(x)), labels=c("L", "H"), include.lowest=TRUE)
wx <- stats::lag(nb2listw(temp1_nb, style="C"), temp$intoxicaciones)
lhwx <- cut(wx, breaks=c(min(wx), mean(wx), max(wx)), labels=c("L", "H"), include.lowest=TRUE)
lhlh <- interaction(lhx, lhwx, infl, drop=TRUE)
cols <- rep(1, length(lhlh))
cols[lhlh == "H.L.TRUE"] <- 2
cols[lhlh == "L.H.TRUE"] <- 3
cols[lhlh == "H.H.TRUE"] <- 4
plot(temp, col=brewer.pal(4, "Accent")[cols])
legend("topright", legend=c("Ninguno", "HL", "LH", "HH"), fill=brewer.pal(4, "Accent"), bty="n", cex=0.8, y.intersp=0.8)
title("Gráfico 5:\nCantones de influencia en casos totales", outer = TRUE)
```

```{r, out.width= '5in', fig.align = 'center'}
lm1 <- localmoran(temp$intoxicaciones, listw=nb2listw(temp1_nb, style="C"))
lm2 <- as.data.frame(localmoran.sad(lm(intoxicaciones ~ 1, temp), nb=temp1_nb, style="C"))
lm3 <- as.data.frame(localmoran.exact(lm(intoxicaciones ~ 1, temp), nb=temp1_nb, style="C"))

temp$Normal <- lm2[,3]
temp$Aleatorizado <- lm1[,5]
temp$Punto_de_silla <- lm2[,5]
temp$Exacto <- lm3[,5]
gry <- c(rev(brewer.pal(6, "Reds")), brewer.pal(6, "Blues"))
spplot(temp, c("Normal", "Aleatorizado", "Punto_de_silla", "Exacto"), at=c(0,0.01,0.05,0.1,0.9,0.95,0.99,1), col.regions=colorRampPalette(gry)(7), main = "Gráfico 6:\nProbabilidad de cada supuesto\n en intoxicaciones totales")
```

```{r, out.width= '5in', fig.align = 'center'}
oopar <- par(mfrow=c(1,2), oma = c(0, 0, 2, 0))
msp <- moran.plot(temp$llamadas_10mil, listw=nb2listw(temp1_nb, style="C"), quiet=TRUE, xlab = "Intoxicaciones por 10K", ylab = "Intoxicaciones por 10K rezagadas espacialmente")
infl <- apply(msp$is.inf, 1, any)
x <- temp$llamadas_10mil
lhx <- cut(x, breaks=c(min(x), mean(x), max(x)), labels=c("L", "H"), include.lowest=TRUE)
wx <- stats::lag(nb2listw(temp1_nb, style="C"), temp$llamadas_10mil)
lhwx <- cut(wx, breaks=c(min(wx), mean(wx), max(wx)), labels=c("L", "H"), include.lowest=TRUE)
lhlh <- interaction(lhx, lhwx, infl, drop=TRUE)
cols <- rep(1, length(lhlh))
cols[lhlh == "H.L.TRUE"] <- 2
cols[lhlh == "L.H.TRUE"] <- 3
cols[lhlh == "H.H.TRUE"] <- 4
plot(temp, col=brewer.pal(4, "Accent")[cols])
legend("topright", legend=c("Ninguno", "HL", "LH", "HH"), fill=brewer.pal(4, "Accent"), bty="n", cex=0.8, y.intersp=0.8)
title("Gráfico 7:\nCantones de influencia en casos por 10 mil", outer = TRUE)
```

```{r, out.width= '5in', fig.align = 'center'}
lm1 <- localmoran(temp$llamadas_10mil, listw=nb2listw(temp1_nb, style="C"))
lm2 <- as.data.frame(localmoran.sad(lm(llamadas_10mil ~ 1, temp), nb=temp1_nb, style="C"))
lm3 <- as.data.frame(localmoran.exact(lm(llamadas_10mil ~ 1, temp), nb=temp1_nb, style="C"))

temp$Normal <- lm2[,3]
temp$Aleatorizado <- lm1[,5]
temp$Punto_de_silla <- lm2[,5]
temp$Exacto <- lm3[,5]
gry <- c(rev(brewer.pal(6, "Reds")), brewer.pal(6, "Blues"))
spplot(temp, c("Normal", "Aleatorizado", "Punto_de_silla", "Exacto"), at=c(0,0.01,0.05,0.1,0.9,0.95,0.99,1), col.regions=colorRampPalette(gry)(7), main = "Gráfico 8:\nProbabilidad de cada supuesto en \nintoxicaciones por 10 mil habitantes")
```

Comparando los gráficos 5 y 7, se puede notar que los cantones de influencia y la dispersión de estos según los rezagos son distintos. Este resultado concuerda con lo discutido de los gráficos 1 y 2, donde, cuando se toma la cantidad de intoxicaciones totales, hay pocos cantones con muchas intoxicaciones, que serían los cantones de influencia del Gráfico 5, mientras que, cuando se toma la tasa de intoxicaciones por 10 mil habitantes, la dispersión de los cantones es más uniforme ya que, como se puede notar del Gráfico 2, hay mayor cantidad de cantones en todos los rangos de la escala. Luego, con respecto al Gráfico 6, se puede notar que hay un aglomerado de los cantones de Puntarenas, Montes de Oro y San Ramón, mientras que el cantón de San Carlos, al tener tantas intoxicaciones a diferencia de sus vecinos, es un punto caliente. Por lo tanto, aunque parecen haber algomeraciones, no son muy fuertes, a diferencia de los resultados del Gráfico 8, donde, al igual que se comentó para el Gráfico 2, se pueden notar dos algomeraciones muy fuertes cerca de los cantones de Coto Brus, Buenos Aires, Talamanca y Limón en el este del país y de los cantones de Upala, Los Chiles y Guatuso en el norte del país, sin importar el supuesto.

# Conclusiones

Con base en los resultados presentados es importante resaltar, de primero, que las relaciones espaciales entre los cantones son distintas dependiendo de si se usa la cantidad total de intoxicaciones o si se usa la tasa de intoxicaciones por 10 mil habitantes. Lo anterior ya que en el primero caso no se logró encontrar autocorrelaciones espaciales, mientras que en el segundo sí, además que, al momento de analizar posibles aglomeraciones, en el primer caso las aglomeraciones no son tan fuertes y hay varios puntos calientes, a diferencia del segundo caso, donde las aglomeraciones son más grandes y más fuertes.

Por otro lado, es importante notar que los datos usados en este artículo son la totalidad de casos entre el 2007 y el 2014, pero además se tienen los datos separados según año por lo que, en un análisis posterior, puede ser pertinente estudiar el cambio en las relaciones espaciales de los cantones, no solamente en términos de casos absolutos y relativos, sino también en términos temporales.

# Referencias

- Martínez, C., Gómez, S. (2007). \textit{Riesgo genotóxico por exposición a plaguicidas en trabajadores agrícolas}. Revista Internacional de Contaminación Ambiental: 23 (4), 185-200.
- Grillet, M., Martínez, J. & Barrera, R.(2009). \textit{Focos calientes de transmisión de malaria: Implicaciones para un control orientado y efectivo en Venezuela}. Boletin de Malariologia y salud Ambiental: 29 (2), 193-208.
- Santamaría, C.(2003). \textit{El análisis espacial como herramienta para evaluar alarmas por cáncer}. Población y Salud en Mesoamerica: 1 (1), 1-9.



